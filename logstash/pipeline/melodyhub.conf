input {
  file {
    path => "/var/log/melodyhub/melodyhub.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
  }
}

filter {
  # Parse JSON logs from application
  if [message] {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
  }

  # Add timestamp
  date {
    match => [ "@timestamp", "ISO8601" ]
    target => "@timestamp"
  }

  # Categorize logs by level
  if [level] == "ERROR" or [level] == "WARN" {
    mutate {
      add_tag => [ "alert" ]
    }
  }

  # Tag domain events for easier filtering
  if [eventType] {
    mutate {
      add_tag => [ "domain_event" ]
    }
  }

  # Tag transaction-related logs
  if [transactionId] {
    mutate {
      add_tag => [ "transaction" ]
    }
  }

  # Tag user-related logs
  if [userId] {
    mutate {
      add_tag => [ "user_activity" ]
    }
  }

  # Tag music-related logs
  if [musicId] or [playlistId] {
    mutate {
      add_tag => [ "music_activity" ]
    }
  }

  # Add environment information
  mutate {
    add_field => {
      "[@metadata][index]" => "melodyhub-%{+YYYY.MM.dd}"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    document_type => "_doc"
  }

  # Output to stdout for debugging (optional)
  # Uncomment for troubleshooting
  # stdout {
  #   codec => rubydebug
  # }
}
